name: Deploy on PR Merge

on:
    pull_request:
        types: [closed]
        branches: [main]

jobs:
    deploy:
        if: github.event.pull_request.merged == true
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup SSH
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: Deploy to server
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
                    REPO_URL="git@github.com:${{ github.repository }}.git"
                    if [ -d ~/ally ]; then
                      cd ~/ally
                      git pull origin main
                    else
                      git clone $REPO_URL ~/ally
                      cd ~/ally
                    fi
                    npm ci
                    export DISCORD_TOKEN="${{ secrets.DISCORD_TOKEN }}"
                    export DISCORD_CLIENT_ID="${{ secrets.DISCORD_CLIENT_ID }}"
                    export MONGODB_URI="${{ secrets.MONGODB_URI }}"
                    export PNW_API_KEY="${{ secrets.PNW_API_KEY }}"
                    export NODE_ENV="production"
                    export ENABLE_SUBSCRIPTIONS="true"
                    pm2 describe ally > /dev/null 2>&1 && pm2 reload ecosystem.config.js || pm2 start ecosystem.config.js
                  EOF
